name: android-build

permissions:
  contents: read

on:
  push:
    branches:
      - main
  pull_request:
    types:
      - opened
      - reopened
      - synchronize

concurrency:
  group: '${{ github.workflow }}-${{ github.head_ref || github.run_id }}'
  cancel-in-progress: true

jobs:
  build-android:
    name: 'build android ${{ matrix.arch }}'
    runs-on: ubuntu-24.04
    timeout-minutes: 60
    strategy:
      matrix:
        arch: [aarch64, x86_64]
      fail-fast: false
    
    steps:
      - name: Configure git
        run: |
          git config --global core.symlinks true
          git config --global fetch.parallel 32
      
      - name: Clone repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 5
          submodules: false
      
      - name: Clone submodule ./tests/util/std
        run: git submodule update --init --recursive --depth=1 -- ./tests/util/std
      
      - name: Cache Cargo home
        uses: cirruslabs/cache@v4
        with:
          path: |
            ~/.cargo/.crates.toml
            ~/.cargo/.crates2.json
            ~/.cargo/bin
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
          key: 'cargo-home-android-${{ matrix.arch }}-${{ hashFiles(''Cargo.lock'') }}'
          restore-keys: 'cargo-home-android-${{ matrix.arch }}-'
      
      - uses: dsherret/rust-toolchain-file@v1
      
      - name: Add Android targets
        run: |
          rustup target add ${{ matrix.arch }}-linux-android
      
      # [NEW STEP] Install cargo-ndk to handle environment setup for C/C++ deps
      - name: Install cargo-ndk
        run: cargo install cargo-ndk

      - name: Check compilation (without V8)
        run: |
          # We use `cargo ndk` to wrap the check command. 
          # It sets CC, CXX, and PATH so aws-lc-sys can find the NDK compiler.
          cargo ndk -t ${{ matrix.arch }}-linux-android check --target ${{ matrix.arch }}-linux-android --locked --workspace --exclude v8
      
      - name: Report status
        if: success()
        run: |
          echo "\u2705 Deno Rust code successfully compiles for Android ${{ matrix.arch }}"
          echo ""
          echo "Note: Full Android build with V8 requires patches from Termux."
          echo "See: https://github.com/termux/termux-packages/tree/master/packages/deno"

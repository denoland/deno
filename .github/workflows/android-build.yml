# GN args for V8 build
          EXTRA_GN_ARGS: 'android_ndk_api_level=24 use_jumbo_build=true'
          # Explicitly set target architecture for Android
          GN_ARGS: 'target_os="android" target_cpu="${{ matrix.arch == ''aarch64'' && ''arm64'' || ''x64'' }}" v8_enable_i18n_support=false is_component_build=false'name: android-build

permissions:
  contents: read

on:
  push:
    branches:
      - main
  pull_request:
    types:
      - opened
      - reopened
      - synchronize

concurrency:
  group: '${{ github.workflow }}-${{ github.head_ref || github.run_id }}'
  cancel-in-progress: true

jobs:
  build-android:
    name: 'build android ${{ matrix.arch }}'
    runs-on: ubuntu-24.04
    timeout-minutes: 90
    strategy:
      matrix:
        arch: [aarch64, x86_64]
      fail-fast: false
    
    steps:
      - name: Configure git
        run: |
          git config --global core.symlinks true
          git config --global fetch.parallel 32
      
      - name: Clone repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 5
          submodules: false
      
      - name: Clone submodule ./tests/util/std
        run: git submodule update --init --recursive --depth=1 -- ./tests/util/std
      
      - name: Cache Cargo home
        uses: cirruslabs/cache@v4
        with:
          path: |
            ~/.cargo/.crates.toml
            ~/.cargo/.crates2.json
            ~/.cargo/bin
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
          key: 'cargo-home-android-${{ matrix.arch }}-${{ hashFiles(''Cargo.lock'') }}'
          restore-keys: 'cargo-home-android-${{ matrix.arch }}-'
      
      - uses: dsherret/rust-toolchain-file@v1
      
      - name: Install Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x
      
      - name: Add Android targets
        run: |
          rustup target add ${{ matrix.arch }}-linux-android
      
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 curl unzip git
      
      - name: Build for Android
        env:
          # Build V8 from source since prebuilt binaries don't exist for Android
          V8_FROM_SOURCE: 1
          # Set API level
          ANDROID_NDK_API_LEVEL: '24'
          # Python for V8 build scripts
          PYTHON: python3
          # Linkers
          CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER: aarch64-linux-android24-clang
          CARGO_TARGET_X86_64_LINUX_ANDROID_LINKER: x86_64-linux-android24-clang
          # Compilers for build scripts
          CC_aarch64_linux_android: aarch64-linux-android24-clang
          CXX_aarch64_linux_android: aarch64-linux-android24-clang++
          AR_aarch64_linux_android: llvm-ar
          CC_x86_64_linux_android: x86_64-linux-android24-clang
          CXX_x86_64_linux_android: x86_64-linux-android24-clang++
          AR_x86_64_linux_android: llvm-ar
          # GN args for V8 build - disable Rust to avoid the missing file error
          EXTRA_GN_ARGS: 'android_ndk_api_level=24 use_jumbo_build=true enable_rust=false v8_monolithic=true v8_enable_test_features=false'
          # Set target CPU for GN
          GN_ARGS: 'target_os="android" target_cpu="${{ matrix.arch == ''aarch64'' && ''arm64'' || ''x64'' }}" is_official_build=false'
        run: |
          cargo build --target ${{ matrix.arch }}-linux-android --locked
      
      - name: Verify binary exists
        run: |
          ls -lh target/${{ matrix.arch }}-linux-android/debug/deno
